syntax = "proto3";

package proto;

// Service for authentication, session management, and OAuth integration.
service ApiService {
    // Creates a new session for a user.
    rpc CreateSession(CreateSessionReq) returns (CreateSessionResp) {}
    // Validates an existing session token.
    rpc ValidateSession(ValidateSessionReq) returns (ValidateSessionResp) {}
    // Deletes/invalidates a session.
    rpc DeleteSession(DeleteSessionReq) returns (DeleteSessionResp) {}

    // Starts OAuth login flow and returns authorization URL.
    rpc StartOauthLogin(StartOauthLoginReq) returns (StartOauthLoginResp) {}
    // Handles OAuth callback and exchanges code for tokens.
    rpc HandleOauthCallback(HandleOauthCallbackReq) returns (HandleOauthCallbackResp);
    // Links an OAuth account to a user.
    rpc LinkOauthAccount(LinkOauthAccountReq) returns (LinkOauthAccountResp) {}
    // Gets OAuth account information for a user.
    rpc GetOauthAccount(GetOauthAccountReq) returns (GetOauthAccountResp) {}
}

message Session {
    // The session token.
    string token = 1;
}


message CreateSessionReq {
    // The user ID to create a session for.
    string user_id = 1;
}

message CreateSessionResp {
    // The created session token.
    string token = 1;
}

message ValidateSessionReq {
    // The session token to validate.
    string token = 1;
}

message ValidateSessionResp {
    // The user ID associated with the session.
    string user_id = 1;
    // Whether the session cookie should be refreshed.
    bool should_refresh_cookie = 2;
}

message DeleteSessionReq {
    // The session token to delete.
    string token = 1;
}

message DeleteSessionResp {}

enum OauthProvider {
    OAUTH_PROVIDER_UNSPECIFIED = 0;
    OAUTH_PROVIDER_GOOGLE = 1;
    OAUTH_PROVIDER_GITHUB = 2;
}

message StartOauthLoginReq {
    // The OAuth provider to start login with.
    OauthProvider provider = 1;
}

message StartOauthLoginResp {
    // OAuth state parameter for CSRF protection.
    string state = 1;
    // Authorization URL to redirect user to.
    string authorization_url = 2;
    // Code verifier for PKCE.
    string code_verifier = 3;
}

message HandleOauthCallbackReq {
    // The OAuth provider.
    OauthProvider provider = 1;
    // Authorization code from OAuth callback.
    string code = 2;
    // Code verifier for PKCE.
    string code_verifier = 3;
}

message HandleOauthCallbackResp {
    // The OAuth account ID.
    string account_id = 1;
    // The associated user ID.
    string user_id = 2;
    // User's email from OAuth provider.
    string external_user_email = 3;
    // User's name from OAuth provider.
    string external_user_name = 4;
}

message LinkOauthAccountReq {
    // The OAuth account ID to link.
    string account_id = 1;
    // The user ID to link to.
    string user_id = 2;
}

message LinkOauthAccountResp {}

message GetOauthAccountReq {
    // The user ID to get OAuth account for.
    string user_id = 1;
    // The OAuth provider.
    OauthProvider provider = 2;
}

message GetOauthAccountResp {
    // The external user ID from OAuth provider.
    string external_user_id = 1;
}
